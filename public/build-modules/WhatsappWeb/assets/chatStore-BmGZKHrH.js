import{E as Je,k as n,l as C,p as m}from"./app-BPxwetsb.js";import{e as Be}from"./echoServiceComposable-DU9yHR3K.js";import{t as x}from"./toastComposable-BZSSJ7BC.js";import{u as De}from"./modalStore-CB1x_O57.js";const ze=Je("chatStore",()=>{const X={voice_message:!0},j=n(!1),T=De(),F="/api/whatsapp-web/v1",p=e=>`${F}/${e}`,E=n([]),b=n({}),Y=()=>{var e;return(e=E.value)==null?void 0:e.find(s=>s.id===i.value.sessionId)},J=n({limit:10}),r=n([]),i=n(null),Z=e=>{let s=e==null?void 0:e.uuid;if(!s){c.value.conversations=!1;return}c.value.conversations=!0,m.get(p(`${s}/chats`),{params:{limit:J.value.limit}}).then(a=>{var t,l,u,v;e.cursor=((l=(t=a.data)==null?void 0:t.data)==null?void 0:l.nextCursor)||null,r.value=[...r.value,...((v=(u=a.data)==null?void 0:u.data)==null?void 0:v.chats)||[]]}).catch(a=>{console.error(a),j.value=!0}).finally(()=>c.value.conversations=!1)},ee=()=>{c.value.conversations||(c.value.conversations=!0,E.value.forEach(e=>{let s=e.uuid;e.cursor&&m.get(p(`${s}/chats`),{params:{cursor:e.cursor,limit:J.value.limit}}).then(a=>{var t,l,u,v;r.value=[...r.value,...((l=(t=a.data)==null?void 0:t.data)==null?void 0:l.chats)||[]],e.cursor=((v=(u=a.data)==null?void 0:u.data)==null?void 0:v.nextCursor)||null}).catch(a=>console.error(a)).finally(()=>c.value.conversations=!1)}),c.value.conversations=!1)},se=e=>{i.value=e,ae(e),i.value.messages=[],B(e,!0),_(e.id)==="group"&&ie(e)},ae=e=>{if(e.unreadCount<=0)return;let s=e.sessionId,a=e.id;!a||!s||m.post(p(`${s}/chats/${a}/read`)).then(t=>{e.unreadCount=0}).catch(t=>console.error(t))},te=e=>(e||(e=i.value),e.picture?e.picture:`https://ui-avatars.com/api/?name=${e==null?void 0:e.name}`),_=(e="")=>{var s;return e||(e=(s=i.value)==null?void 0:s.id),e.includes("@g.us")?"group":e!=null&&e.includes("@s.whatsapp.net")?"number":"unknown"},ne=n({limit:10}),B=(e,s=!1)=>{if(c.value.messages||!e&&!i.value)return;e||(e=i.value);let a=e.sessionId,t=e.id;if(!(!a||!t)){if(Object(e).hasOwnProperty("cursor")&&!s&&e.cursor===null){console.log("no more messages");return}c.value.messages=!0,m.get(p(`${a}/chats/${t}`),{params:{limit:ne.value.limit,cursorId:e.cursor}}).then(function(l){var h,y,f,g,k,S,K;let u=((y=(h=l.data)==null?void 0:h.data)==null?void 0:y.messages)||[];if(u.length>0){let qe=[...u,...i.value.messages].filter((Oe,xe,je)=>xe===je.findIndex(Fe=>Fe.key.id===Oe.key.id));i.value.messages=qe}((g=(f=l.data)==null?void 0:f.data)==null?void 0:g.hasMore)?e.cursor=((K=(S=(k=l.data)==null?void 0:k.data)==null?void 0:S.nextCursor)==null?void 0:K.id)||null:e.cursor=null}).catch(l=>console.error(l)).finally(()=>{c.value.messages=!1})}},le=async()=>{const e={jid:i.value.id,type:_(i.value.id),messageType:o.value.type,message:{}};switch(o.value.type){case"text":e.message={text:o.value.message};break;case"image":e.message={image:o.value.file,caption:o.value.caption??null};break;case"audio":e.message={audio:o.value.file,ptt:!1};break;case"voice":e.messageType="voice",e.message={voice:o.value.file};break;case"video":e.message={video:o.value.file,caption:o.value.caption??null,gifPlayback:!1,ptv:!1};break;case"location":e.message=o.value.message;break;case"document":e.message={document:o.value.file};break;case"template":e.messageType=o.value.template.type,e.message=o.value.template.meta;break;default:console.error("Invalid message type: "+o.value.type);return}N.value&&(e.options={quoted:I.value}),c.value.sendingMessage=!0,m.post(p(`${i.value.sessionId}/messages/send`),e,{headers:{"Content-Type":"multipart/form-data"}}).then(s=>{var a;if(T.close(),["audio","video","image"].includes(o.value.type)){let t=s.data.key.id;b.value[t]=o.value.file}o.value.type="text",o.value.message="",(a=H.value)==null||a.focus(),Q()}).finally(()=>{c.value.sendingMessage=!1,G.value=!1,q()}).catch(s=>{var a,t;x.danger(((t=(a=s.response)==null?void 0:a.data)==null?void 0:t.message)||s.message||"Something went wrong!")})},oe=async e=>{if(b.value[e.key.id])return b.value[e.key.id];let s=i.value.sessionId;try{const a=await m.post(p(`${s}/messages/download`),e.key,{responseType:"blob"}),t=new Blob([a.data],{type:a.headers["content-type"]});return b.value[e.id]=URL.createObjectURL(t),b.value[e.id]}catch(a){return console.error("Error downloading file:",a),null}},ie=e=>{e.groupMetadata||(c.value.groupMetadata=!0,m.get(p(`${e.sessionId}/groups/${e.id}`)).then(function(s){i.value.groupMetadata=s.data}).catch(s=>console.error(s)).finally(()=>{c.value.groupMetadata=!1}))},A=n([]),re=C(()=>M.value.customer_name.length>0||M.value.badge_id?(A.value=r.value.filter(e=>{var s;return M.value.badge_id?e.badge_id===M.value.badge_id:M.value.customer_name.length>0?(s=e.name)==null?void 0:s.toLowerCase().includes(M.value.customer_name.toLowerCase()):!0}),A.value):r.value),D=n([]),P=n([]),ue=n([]),ce=n([]),$=n([]),L=n({isOpen:!1}),U=n({isOpen:!1}),G=n(!1),H=n(),I=n(null),M=n({badge_id:null,customer_name:""}),c=n({sendingMessage:!1,messages:!1,conversations:!1,searching:!1,groupMetadata:!1}),o=n({type:"text",message:"",file:null,template:null,location:null}),de=C(()=>r.value.length>0),ve=C(()=>i.value!==null),N=C(()=>I.value??!1),w=C(()=>{let e=P.value;return O.value.length>0&&(e=e.filter(s=>s.message_template.toLowerCase().includes(O.value.toLowerCase()))),e.map(s=>s.message_template)}),ge=C(()=>{var s;let e=[];return((s=o.value.message)==null?void 0:s.length)>0&&(e=P.value.filter(a=>{var t;return a.message_template.toLowerCase().includes((t=o.value.message)==null?void 0:t.toLowerCase())})),e.map(a=>a.message_template)}),fe=C(()=>D.value),me=()=>{L.value.isOpen=!L.value.isOpen},pe=()=>{U.value.isOpen=!U.value.isOpen},q=(e="smooth")=>{setTimeout(()=>{let s=document.querySelector("#scrollContainerRef");s&&s.scrollIntoView({block:"end",behavior:e})},500)},he=e=>{I.value=e},Q=()=>{I.value=null},ye=()=>{r.value=r.value.sort((e,s)=>s.conversationTimestamp-e.conversationTimestamp)},ke=e=>$.value.find(s=>s.id===e)??null,Me=async()=>{try{const e=await m.get(route("user.conversations.api","badges"));$.value=e.data}catch(e){console.error(e)}},d=n(0),O=n(""),Ce=n(!1),R=n(!1),be=n(),Ie=e=>{(R.value&&d.value<w.value.length-1||d.value<w.value.length-1)&&(d.value=d.value+1)},we=e=>{d.value>0&&(d.value=d.value-1)},W=e=>{V(),o.value.message=z(e)},z=e=>{let s={name:i.value.name,phone:i.value.id};return(e==null?void 0:e.replace(/\{([a-z_]+)\}/g,(a,t)=>(s.hasOwnProperty(t)?s[t]:a)??a))??e},Se=()=>{T.open("quickReplyModal"),R.value=!0},V=()=>{T.close("quickReplyModal"),R.value=!1},Re=e=>{let s="";R.value,s=w.value[d.value],W(s),d.value=-1},Te=e=>{console.log("Activating live chat..."),Be.connect().private(e).subscribed(()=>console.log("Live chat activated successfully")).listen("LiveChatNotifyEvent",Ee).error(s=>console.error(s))},Ee=e=>{e.event=="MESSAGES_UPSERT"?_e(e):e.event=="MESSAGES_UPDATE"?Ae(e):e.event=="CHATS_UPSERT"?Pe(e):e.event=="CHATS_UPDATE"?$e(e):console.error(`Unknown event: ${e.event}`)},_e=e=>{var v,h,y,f;const s=e.sessionId,a=(h=(v=e.data)==null?void 0:v.messages)==null?void 0:h[0];if(!a)return;a.sessionId||(a.sessionId=s);let{remoteJid:t,remoteJidAlt:l}=a.key||{};if(!t)return;t.includes("@lid")&&(l!=null&&l.includes("@s.whatsapp.net"))&&(t=l);const u=r.value.find(g=>g.id===t&&g.sessionId===s);if(!u){console.log("Chat not found",{remoteJid:t,sessionId:s,payload:e});return}(y=u.messages)!=null&&y.some(g=>{var k,S;return((k=g.key)==null?void 0:k.id)===((S=a.key)==null?void 0:S.id)})||(u.messages.push(a),a.key.fromMe||Ue(),((f=i.value)==null?void 0:f.id)===u.id&&q())},Ae=e=>{var u,v,h,y;let s=e.sessionId,a=((v=(u=e.data)==null?void 0:u.messages)==null?void 0:v[0])||{},t=(h=a.key)==null?void 0:h.remoteJid,l=(y=a.key)==null?void 0:y.remoteJidAlt;t.includes("@lid")&&l.includes("@s.whatsapp.net")&&(t=l),r.value.forEach(f=>{f.id==t&&f.sessionId==s&&(f.messages=f.messages.map(g=>{var k;return((k=g.key)==null?void 0:k.id)==a.id?{...g,...a}:g}))})},Pe=e=>{var a;(((a=e.data)==null?void 0:a.chats)??[]).forEach(t=>{r.value.find(l=>l.id==t.id)?r.value=r.value.map(l=>l.id==t.id?{...l,...t,sessionId:e.sessionId}:l):r.value.unshift({...t,sessionId:e.sessionId})})},$e=e=>{var a;let s=((a=e.data)==null?void 0:a.chats)??null;s&&(r.value=r.value.map(t=>(t.id==s.id&&(t.conversationTimestamp=s.conversationTimestamp),t)),ye())},Le=()=>{let e=i.value;if(!e)return;let s=e.sessionId,a=e.id;m.post(p(`${s}/chats/${a}/sync`)).then(t=>{e.picture=t.data.url,x.success("Profile synced successfully")}).catch(t=>{console.error("Error fetching profile:",t),x.danger("Failed to sync profile")})},Ue=()=>{new Audio("/assets/incoming-message-online-whatsapp.mp3").play()};return{features:X,disconnected:j,baseApiUrl:F,platforms:E,mediaMessages:b,getActivePlatform:Y,activeConversation:i,conversations:r,fetchConversations:Z,setActiveConversation:se,getConversationProfilePic:te,getConversationType:_,getMedia:oe,searchedConversationList:A,chatTemplates:D,quickReplies:P,aiTemplates:ue,languages:ce,badges:$,rightSidebar:L,leftSidebar:U,replying:I,searchForm:M,loading:c,assetPopup:G,messageInputFieldRef:H,inputMessage:o,quickReplySearchInput:O,quickReplySuggestionItemsShow:Ce,arrowCounter:d,hasConversations:de,hasActiveConversation:ve,isReplying:N,quickReplyFilteredItems:w,quickReplySuggestionItems:ge,getActiveModuleTemplates:fe,filteredConversations:re,toggleRightSidebar:me,toggleLeftSidebar:pe,scrollToLastMessage:q,setReplying:he,unsetReplying:Q,loadMoreMessages:B,loadMoreConversations:ee,addQuickReplyToMessageInput:W,loadBadges:Me,getBadge:ke,submitMessage:le,quickReplyModalOpen:Se,quickReplyModalClose:V,selectQuickReply:Re,onArrowDown:Ie,onArrowUp:we,replaceTextWithShortCodes:z,quickReplyModalSearchInput:be,connectWebSocket:Te,syncProfile:Le}});export{ze as u};
